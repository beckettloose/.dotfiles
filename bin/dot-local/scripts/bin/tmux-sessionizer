#!/usr/bin/env bash

# tmux-sessionizer
#
# Originally written by ThePrimeagen
# Heavily modified by Beckett Loose
#
# Allows the user to quickly create and navigate between tmux sessions that are
# tied to the folders of individual projects. It is highly recommended to map
# this script to a keyboard shortcut such as <C-f> in your shell profile and
# tmux config for quick access.
#
# When this script is executed, it searches the list of provided directories for
# all subdirectories at a depth of 1. The user is then prompted to select a
# directory with an fzf prompt. Once the user selects a directory, a tmux
# session corresponding to it will be created (or attached, if it already
# exists). All shell instances created in this session will default to the
# selected directory for convenience.

if [[ $# -eq 1 ]]; then
    if [[ $1 -eq 1 ]]; then
        :
    fi
# If we are already in tmux, open ourselves in a window
elif [[ -n $TMUX ]]; then
    tmux neww -n sessionizer "tmux-sessionizer 1"
    exit 0
fi

dirs=()

# Find the directories we want to pick from
while IFS= read -r -d '' i; do
    if [[ -d "$i" ]]; then dirs+=("$i"); fi
done <  <(find ~ ~/projects ~/work ~/personal ~/external -mindepth 1 -maxdepth 1 -type d -print0)

# Format directory list and pipe to fzf picker
selected=$(printf "%s\n" "${dirs[@]#$HOME/}" | fzf --scheme=path)

if [[ -z $selected ]]; then
    exit 0
fi

# Add user's home directory back on to selection
selected="${HOME}/${selected}"

# Replace dots with underscores for tmux session name
selected_name=$(basename "$selected" | tr . _)

tmux_running=$(pgrep tmux)

if [[ -z $tmux_running ]]; then
    # Create a new session and attach to it immediately
    tmux new-session -s "$selected_name" -c "$selected"
    exit 0
fi

if ! tmux has-session -t="$selected_name" 2> /dev/null; then
    # Create the new session in the background
    tmux new-session -ds "$selected_name" -c "$selected"
fi

# If we are not currently in tmux
if [[ -z $TMUX ]]; then
    tmux attach -d -t="$selected_name"
    exit 0
fi

# Otherwise, switch to the existing session
tmux switch-client -t "$selected_name"

